# Homework Assistant

## Overview

This is a full-stack web application that provides AI-powered homework assistance. The application allows users to submit text, images, PDFs, and documents, then processes them using various Large Language Model (LLM) providers to generate detailed solutions. The system features drag-and-drop file uploads, voice input capabilities, mathematical notation rendering, and PDF export functionality.

## System Architecture

The application follows a full-stack architecture with clear separation between client and server:

### Frontend (React + TypeScript)
- **Framework**: React 18 with TypeScript
- **Build Tool**: Vite for fast development and optimized builds
- **UI Framework**: Shadcn/ui components built on Radix UI primitives
- **Styling**: Tailwind CSS with custom design tokens
- **State Management**: TanStack Query for server state management
- **Routing**: Wouter for lightweight client-side routing
- **Math Rendering**: MathJax for mathematical notation display
- **Graph Display**: Integrated image display for auto-generated graphs

### Backend (Node.js + Express)
- **Runtime**: Node.js with TypeScript
- **Framework**: Express.js for API routes
- **Database**: PostgreSQL with Drizzle ORM
- **File Processing**: Multer for file uploads with support for PDFs, images, and documents
- **OCR**: Tesseract.js for image text extraction
- **PDF Processing**: pdf2json for PDF text extraction
- **Graph Generation**: Chart.js with ChartJSNodeCanvas for automatic graph creation

### Database Schema
- **Primary Entity**: `assignments` table storing:
  - Input text and file metadata
  - Processing results and LLM responses
  - Auto-generated graph data and images
  - Provider information and processing times
  - Creation timestamps

## Key Components

### File Processing Pipeline
1. **File Upload**: Drag-and-drop or file picker interface
2. **Text Extraction**: 
   - Images: OCR using Tesseract.js
   - PDFs: Text extraction using pdf2json
   - Documents: Direct text processing
3. **LLM Processing**: Integration with multiple AI providers
4. **Graph Detection & Generation**: Automatic detection of graph requirements and creation
5. **Response Generation**: Formatted solutions with math notation and embedded graphs

### Integrated Graph Generation System
- **Automatic Detection**: Smart detection of homework assignments requiring graphs/plots
- **LLM Integration**: AI providers generate graph data alongside solutions
- **Chart Creation**: Server-side graph generation using Chart.js and Canvas
- **Frontend Display**: Seamless integration of graphs within solution presentations
- **Supported Types**: Line charts, bar charts, and scatter plots
- **Data Sources**: Scientifically accurate data generated by AI based on assignment context

### LLM Integration
- **Anthropic Claude**: Primary AI provider for text processing
- **OpenAI GPT**: Alternative provider option
- **Azure OpenAI**: Enterprise-grade OpenAI integration
- **Provider Selection**: User-selectable AI model choice

### Voice Input System
- **Speech Recognition**: Browser-based Web Speech API
- **Azure Speech Services**: Enhanced speech-to-text capabilities
- **Real-time Transcription**: Live voice input with interim results

### Mathematical Notation
- **MathJax Integration**: Automatic rendering of mathematical expressions
- **LaTeX Support**: Full LaTeX mathematical notation support
- **Print Optimization**: Specialized formatting for PDF generation

## Data Flow

1. **Input Processing**:
   - User submits text or uploads files
   - Files are processed for text extraction
   - Content is validated and analyzed for graph requirements

2. **AI Processing**:
   - Extracted text is sent to selected LLM provider with graph detection
   - AI generates detailed solution with step-by-step explanations
   - If graphs are required, AI also provides structured graph data
   - Response and graph data are processed and stored

3. **Graph Generation** (when required):
   - Graph data is extracted from AI response
   - Chart.js generates professional graphs on server
   - Graph images are encoded and stored alongside solutions

4. **Output Generation**:
   - Solutions are rendered with mathematical notation
   - Generated graphs are displayed above text solutions
   - Content is formatted for display and export with integrated graphs
   - Users can edit, save, or export complete solutions

## External Dependencies

### Core Dependencies
- **Database**: PostgreSQL (configured via DATABASE_URL)
- **LLM APIs**: Anthropic, OpenAI, Azure OpenAI (API keys required)
- **CDN Services**: MathJax, Google Fonts
- **Speech Services**: Azure Cognitive Services (optional)

### Development Dependencies
- **Build Tools**: Vite, ESBuild, TypeScript compiler
- **Linting**: ESLint with TypeScript support
- **CSS Processing**: PostCSS with Tailwind CSS

## Deployment Strategy

### Build Process
1. **Frontend Build**: Vite builds React application to `dist/public`
2. **Backend Build**: ESBuild bundles server code to `dist/index.js`
3. **Database Migration**: Drizzle applies schema changes
4. **Static Assets**: Client assets served from server

### Environment Configuration
- **Development**: Local development with hot reloading
- **Production**: Optimized builds with environment-specific configurations
- **Database**: Automated provisioning via Replit PostgreSQL

### Hosting Requirements
- **Node.js Runtime**: Version 20+ required
- **PostgreSQL Database**: Persistent storage for assignments
- **External API Access**: Outbound connections for LLM providers
- **File Upload Support**: Temporary file storage for processing

## Changelog

- June 17, 2025. Initial setup
- June 17, 2025. Integrated automatic graph generation for homework assignments requiring visual components
- June 17, 2025. Implemented dual-download PDF system: separate graph PDF and solution PDF when graphs are generated
- June 17, 2025. **COMPLETED**: Dual-download PDF system fully functional - automatically downloads both graph PDF and solution PDF with embedded graph
- June 17, 2025. Removed AI detection interface to maximize solution viewing space
- June 17, 2025. **COMPLETED**: Multi-graph protocol for assignments requiring multiple graphs with 1+n PDF structure
- June 17, 2025. Updated database schema to support multiple graphs using arrays (graphImages, graphData arrays)
- June 17, 2025. Modified all LLM processing functions to detect and generate multiple graphs per assignment
- June 17, 2025. Implemented PDF combining functionality for 1+n document structure (n graph documents + 1 solution document)
- June 17, 2025. Updated frontend to display all graphs before main text content according to multi-graph protocol
- June 18, 2025. Multi-graph protocol tested and confirmed working - successfully generates and combines multiple graph PDFs
- June 19, 2025. Enhanced chat interface with larger input area, improved styling, and better user experience for lengthy conversations
- June 27, 2025. **COMPLETED**: Math View Toggle - Added prominent toggle button in solution window allowing users to switch between Math View (rendered notation) and Edit View (raw text) with distinct visual styling
- July 2, 2025. **COMPLETED**: PDF Math Rendering Fix - Extended MathJax rendering time to 5 seconds, added proper promise handling, visual loading indicator, and improved CSS styling for perfect mathematical notation in PDF exports
- July 2, 2025. **COMPLETED**: DeepSeek Integration - Added DeepSeek as an LLM provider option and made it the default, providing users with access to competitive AI capabilities
- July 2, 2025. **COMPLETED**: Print-Save-as-PDF Restoration - Restored the print preview functionality that opens a new window showing the PDF preview before saving, allowing users to see and verify content before download
- July 12, 2025. **COMPLETED**: Token-Based Payment System - Implemented comprehensive token-based payment system with Stripe integration, user authentication (username/password only), and session tracking for both registered and anonymous users
- July 12, 2025. **COMPLETED**: Simplified Authentication - Removed email requirements and verification; users only need username and password for registration to avoid technical issues
- July 12, 2025. **COMPLETED**: UI Improvements - Replaced inappropriate "NUKE" button with dignified "Clear All" button positioned properly to avoid covering other interface elements
- July 12, 2025. **COMPLETED**: Password Visibility Toggle - Added eye icon toggles to all password fields in authentication dialog for better user experience
- July 12, 2025. **COMPLETED**: Token Information Accuracy - Corrected free token display from "1000 tokens/day" to "1000 tokens total" reflecting actual one-time allowance
- July 12, 2025. **COMPLETED**: Header Layout Fix - Restructured header with two-row layout to prevent button overlapping and ensure proper spacing
- July 12, 2025. **COMPLETED**: Multi-User Database Isolation - Implemented comprehensive user isolation system following Neon Database protocol with secure per-user data scoping, CASCADE DELETE constraints, and cross-user access prevention
- July 21, 2025. **COMPLETED**: Document Analysis Enhancement - Fixed critical formatting issues in document summarization by implementing intelligent content detection and specialized academic formatting with proper paragraph breaks, headings, and structured analysis
- July 21, 2025. **COMPLETED**: PayPal Payment Integration - Replaced Stripe with PayPal payment system using PayPal Server SDK, added PayPal routes and components, implemented graceful fallback for invalid credentials
- July 28, 2025. **IN PROGRESS**: PDF Math Rendering Fix - Enhanced MathJax loading and rendering in PDF export to properly convert LaTeX notation to formatted mathematical expressions
- July 31, 2025. **COMPLETED**: Graph Generation Fix - Modified graph detection algorithm to only generate graphs when explicitly requested (e.g., "plot the", "graph the", "draw a graph") instead of triggering on general mathematical terms
- July 31, 2025. **COMPLETED**: Multi-User Authentication System - Verified complete multi-user support with special admin privileges for jmkuczynski and randyjohnson (unlimited tokens, no password required) while maintaining standard authentication for regular users (password required, token-based billing)
- August 1, 2025. **COMPLETED**: Deployment Authentication Fix - Fixed server startup issues in production by removing reusePort configuration and ensuring proper environment variable handling for deployment authentication

## Security Architecture

### Multi-User Data Isolation System
- **Single Database**: One shared Neon PostgreSQL database with user-scoped data access
- **User Isolation**: All queries automatically filtered by user_id from authenticated session
- **Cross-User Protection**: Users cannot access, modify, or delete other users' data
- **CASCADE DELETE**: When user is deleted, all their data is automatically removed
- **URL Manipulation Protection**: Direct assignment access requires matching user_id
- **Anonymous User Support**: Anonymous users see only sessionId-scoped data

### Security Enforcement Points
1. **Database Layer**: Foreign key constraints with CASCADE DELETE
2. **Storage Layer**: All queries include user_id filtering conditions
3. **API Layer**: Session-based user identification for all protected routes
4. **Frontend Layer**: User-specific data display and interactions

### Data Scoping Rules
- **Authenticated Users**: Can only see/modify assignments where user_id matches their session
- **Anonymous Users**: Can only see/modify assignments where user_id is NULL and sessionId matches
- **No Cross-User Access**: Users cannot access other users' assignments even with direct URLs
- **Secure Deletion**: Users can only delete their own assignments

## User Preferences

Preferred communication style: Simple, everyday language.
Username jmkuczynski: Unlimited access with 99,999,999 tokens (maximum credits).
Username randyjohnson: Unlimited access with 99,999,999 tokens (maximum credits) - no password required.